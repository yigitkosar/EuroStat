<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EuroLeague Stats Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: bold;
        }

        .nav-btn:hover {
            background: white;
            color: #1e3c72;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .admin-badge {
            background: #ffd700;
            color: #1e3c72;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .login-container h2 {
            color: #1e3c72;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .sample-users {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
        }

        .favorite-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .favorite-btn:hover {
            background: #764ba2;
        }

        .favorite-btn.favorited {
            background: #ffd700;
            color: #1e3c72;
        }

        .edit-btn {
            padding: 8px 16px;
            background: #ffd700;
            color: #1e3c72;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }

        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }

        .search-container {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-bar input {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-results {
            max-width: 600px;
            margin: 20px auto 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .result-type {
            display: inline-block;
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 10px;
        }

        .content {
            padding: 30px;
            min-height: 400px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 1.8em;
            color: #1e3c72;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th {
            background: #1e3c72;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .clickable {
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            transition: color 0.2s;
        }

        .clickable:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .top-lists {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .top-lists {
                grid-template-columns: 1fr;
            }
        }

        .list-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .list-section h3 {
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: #764ba2;
        }

        .player-header, .team-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .player-name, .team-name {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subsection {
            margin-top: 30px;
        }

        .acar_yigit{ 
            align-items:  left; /* <3 Branko */
        }

        .subsection h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .match-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .match-teams {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-top: 15px;
        }

        .match-team {
            font-size: 1.5em;
            font-weight: bold;
            color: #1e3c72;
        }

        .match-score {
            font-size: 2em;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÄ EuroLeague Stats Explorer</h1>
            <div class="nav-buttons">
                <button class="nav-btn" onclick="showView('home')" id="homeBtn" style="display:none;">Home</button>
                <button class="nav-btn" id="favoritesBtn" onclick="loadFavorites()" style="display: none;">‚ù§Ô∏è Favorites</button>
                <div id="userInfoSection"></div>
            </div>
        </div>

        <div class="search-container" id="searchContainer" style="display:none;">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search players or teams..." oninput="handleSearch()">
            </div>
            <div id="searchResults" class="search-results" style="display: none;"></div>
        </div>

        <div class="content">
            <!-- LOGIN VIEW -->
            <div id="loginView" class="view active">
                <div class="login-container">
                    <h2>üèÄ Login to EuroLeague Stats</h2>
                    <form onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="loginUsername" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" required>
                        </div>
                        <button type="submit" class="login-btn">Login</button>
                    </form>
                    <div class="sample-users">
                        <strong>üìã Sample Users:</strong><br><br>
                        <strong>Admin:</strong> username: <code>admin</code> / password: <code>admin123</code><br><br>
                        <strong>Regular Users:</strong><br>
                        ‚Ä¢ <code>john_doe</code> / <code>password1</code><br>
                        ‚Ä¢ <code>jane_smith</code> / <code>password2</code><br>
                        ‚Ä¢ <code>mike_jordan</code> / <code>password3</code><br>
                        ‚Ä¢ <code>sarah_lee</code> / <code>password4</code><br>
                        ‚Ä¢ <code>alex_brown</code> / <code>password5</code>
                    </div>
                </div>
            </div>

            <!-- HOME VIEW -->
            <div id="homeView" class="view">
                <h2 class="section-title">Dashboard</h2>
                <div class="top-lists">
                    <div class="list-section">
                        <h3>üèÜ Top 5 Players (Points Per Game)</h3>
                        <div id="topPlayers" class="loading">Loading...</div>
                    </div>
                    <div class="list-section">
                        <h3>‚≠ê Top 5 Teams (Points Per Game)</h3>
                        <div id="topTeams" class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- PLAYER VIEW -->
            <div id="playerView" class="view">
                <button class="back-button" onclick="showView('home')">‚Üê Back to Home</button>
                <div id="playerContent"></div>
            </div>

            <!-- TEAM VIEW -->
            <div id="teamView" class="view">
                <button class="back-button" onclick="showView('home')">‚Üê Back to Home</button>
                <div id="teamContent"></div>
            </div>

            <!-- MATCH VIEW -->
            <div id="matchView" class="view">
                <button class="back-button" onclick="showView('home')">‚Üê Back to Home</button>
                <div id="matchContent"></div>
            </div>

            <!-- FAVORITES VIEW -->
            <div id="favoritesView" class="view">
                <button class="back-button" onclick="showView('home')">‚Üê Back to Home</button>
                <h2 class="section-title">‚ù§Ô∏è My Favorites</h2>
                <div id="favoritesContent" class="loading">Loading favorites...</div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="edit-modal">
        <div class="edit-modal-content">
            <h2 id="editModalTitle">Edit</h2>
            <div id="editModalFields"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveEdit()" class="login-btn">Save Changes</button>
                <button onclick="closeEditModal()" class="back-button" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000/api';
        let searchTimeout;
        let currentUser = null;
        let editTarget = null;

        // Initialize on page load
        window.onload = async function() {
            await checkLoginStatus();
        };

        // Check if user is logged in
        async function checkLoginStatus() {
            try {
                const response = await fetch(`${API_BASE}/current_user`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.logged_in) {
                    currentUser = data.user;
                    updateUIForLoggedInUser();
                    showView('home');
                    loadHomeData();
                } else {
                    showView('login');
                }
            } catch (error) {
                console.error('Error checking login status:', error);
                showView('login');
            }
        }

        // Update UI for logged in user
        function updateUIForLoggedInUser() {
            const userInfoSection = document.getElementById('userInfoSection');
            const favBtn = document.getElementById('favoritesBtn');
            const homeBtn = document.getElementById('homeBtn');
            const searchContainer = document.getElementById('searchContainer');
            
            let html = '<div class="user-info">';
            html += `<span>Welcome, <strong>${currentUser.username}</strong></span>`;
            if (currentUser.is_admin) {
                html += '<span class="admin-badge">ADMIN</span>';
            }
            html += '<button class="nav-btn" onclick="handleLogout()">Logout</button>';
            html += '</div>';
            
            userInfoSection.innerHTML = html;
            favBtn.style.display = 'inline-block';
            homeBtn.style.display = 'inline-block';
            searchContainer.style.display = 'block';
        }

        // Handle Login
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    updateUIForLoggedInUser();
                    showView('home');
                    loadHomeData();
                } else {
                    alert('Invalid username or password');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        }

        // Handle Logout
        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                currentUser = null;
                document.getElementById('userInfoSection').innerHTML = '';
                document.getElementById('favoritesBtn').style.display = 'none';
                document.getElementById('homeBtn').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                showView('login');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Favorites Functions
        async function toggleFavorite(targetId, targetType) {
            if (!currentUser) {
                alert('Please login to add favorites');
                return;
            }

            try {
                // Check if already favorited
                const checkResponse = await fetch(
                    `${API_BASE}/favorites/check?target_id=${targetId}&target_type=${targetType}`,
                    { credentials: 'include' }
                );
                const checkData = await checkResponse.json();
                
                const endpoint = checkData.is_favorite ? 'remove' : 'add';
                
                const response = await fetch(`${API_BASE}/favorites/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ target_id: targetId, target_type: targetType })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update button appearance
                    const btn = document.querySelector(`[data-fav-id="${targetId}"]`);
                    if (btn) {
                        if (endpoint === 'add') {
                            btn.classList.add('favorited');
                            btn.textContent = '‚ù§Ô∏è Favorited';
                        } else {
                            btn.classList.remove('favorited');
                            btn.textContent = 'ü§ç Add to Favorites';
                        }
                    }
                }
            } catch (error) {
                console.error('Favorite toggle error:', error);
            }
        }

        async function loadFavorites() {
            if (!currentUser) {
                showView('login');
                return;
            }

            showView('favorites');
            document.getElementById('favoritesContent').innerHTML = '<div class="loading">Loading favorites...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/favorites`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                let html = '';
                
                if (data.players.length > 0) {
                    html += '<div class="subsection"><h3>Favorite Players</h3><table><thead><tr>';
                    html += '<th>Player</th><th>Team</th><th>PPG</th><th>APG</th><th>RPG</th><th>FG%</th><th>Rating</th><th>Actions</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.players.forEach(player => {
                        html += `
                            <tr>
                                <td class="clickable" onclick="loadPlayer('${player.player_id}')">${player.player}</td>
                                <td class="clickable" onclick="loadTeam('${player.team_id}')">${player.team_id}</td>
                                <td>${player.points_per_game.toFixed(1)}</td>
                                <td>${player.assists_per_game.toFixed(1)}</td>
                                <td>${player.total_rebounds_per_game.toFixed(1)}</td>
                                <td>${player.fg_percentage.toFixed(1)}%</td>
                                <td>${player.eurostat_rating.toFixed(1)}</td>
                                <td>
                                    <button class="favorite-btn favorited" onclick="toggleFavorite('${player.player_id}', 'player'); setTimeout(loadFavorites, 500)">Remove</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table></div>';
                }
                
                if (data.teams.length > 0) {
                    html += '<div class="subsection"><h3>Favorite Teams</h3><table><thead><tr>';
                    html += '<th>Team</th><th>PPG</th><th>APG</th><th>RPG</th><th>FG%</th><th>Actions</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.teams.forEach(team => {
                        html += `
                            <tr class="acar_yigit">
                                <td class="clickable" onclick="loadTeam('${team.team_id}')">${team.team_id}</td>
                                <td>${team.points_per_game.toFixed(1)}</td>
                                <td>${team.assists_per_game.toFixed(1)}</td>
                                <td>${team.total_rebounds_per_game.toFixed(1)}</td>
                                <td>${team.fg_percentage.toFixed(1)}%</td>
                                <td>
                                    <button class="favorite-btn favorited" onclick="toggleFavorite('${team.team_id}', 'team'); setTimeout(loadFavorites, 500)">Remove</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table></div>';
                }
                
                if (data.players.length === 0 && data.teams.length === 0) {
                    html = '<div style="text-align: center; padding: 40px; color: #666;">No favorites yet. Start adding your favorite players and teams!</div>';
                }
                
                document.getElementById('favoritesContent').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading favorites:', error);
                document.getElementById('favoritesContent').innerHTML = '<div class="error">Error loading favorites.</div>';
            }
        }

        // Admin Edit Functions
        function openEditModal(type, id, currentData) {
            if (!currentUser || !currentUser.is_admin) {
                alert('Admin access required');
                return;
            }

            editTarget = { type, id, currentData };
            
            const modal = document.getElementById('editModal');
            const title = document.getElementById('editModalTitle');
            const fields = document.getElementById('editModalFields');
            
            title.textContent = `Edit ${type === 'player' ? 'Player' : 'Team'}`;
            
            let html = '';
            
            if (type === 'player') {
                html = `
                    <div class="form-group">
                        <label>Player Name</label>
                        <input type="text" id="edit_player" value="${currentData.player}">
                    </div>
                    <div class="form-group">
                        <label>Points Per Game</label>
                        <input type="number" step="0.1" id="edit_points_per_game" value="${currentData.points_per_game}">
                    </div>
                    <div class="form-group">
                        <label>Assists Per Game</label>
                        <input type="number" step="0.1" id="edit_assists_per_game" value="${currentData.assists_per_game}">
                    </div>
                    <div class="form-group">
                        <label>Rebounds Per Game</label>
                        <input type="number" step="0.1" id="edit_total_rebounds_per_game" value="${currentData.rebounds_per_game}">
                    </div>
                    <div class="form-group">
                        <label>Steals Per Game</label>
                        <input type="number" step="0.1" id="edit_steals_per_game" value="${currentData.steals_per_game}">
                    </div>
                `;
            } else {
                html = `
                    <div class="form-group">
                        <label>Team Name</label>
                        <input type="text" id="edit_team_name" value="${currentData.team_name || currentData.team_id}">
                    </div>
                    <div class="form-group">
                        <label>Points Per Game</label>
                        <input type="number" step="0.1" id="edit_points_per_game" value="${currentData.points_per_game}">
                    </div>
                    <div class="form-group">
                        <label>Assists Per Game</label>
                        <input type="number" step="0.1" id="edit_assists_per_game" value="${currentData.assists_per_game}">
                    </div>
                    <div class="form-group">
                        <label>Rebounds Per Game</label>
                        <input type="number" step="0.1" id="edit_total_rebounds_per_game" value="${currentData.total_rebounds_per_game}">
                    </div>
                    <div class="form-group">
                        <label>Steals Per Game</label>
                        <input type="number" step="0.1" id="edit_steals_per_game" value="${currentData.steals_per_game}">
                    </div>
                `;
            }
            
            fields.innerHTML = html;
            modal.classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editTarget = null;
        }

        async function saveEdit() {
            if (!editTarget) return;
            
            const updateData = {};
            const fieldPrefix = 'edit_';
            
            document.querySelectorAll('#editModalFields input').forEach(input => {
                const fieldName = input.id.replace(fieldPrefix, '');
                const value = input.type === 'number' ? parseFloat(input.value) : input.value;
                updateData[fieldName] = value;
            });
            
            try {
                const response = await fetch(
                    `${API_BASE}/admin/${editTarget.type}/${editTarget.id}`,
                    {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(updateData)
                    }
                );
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Updated successfully!');
                    closeEditModal();
                    
                    // Reload current page
                    if (editTarget.type === 'player') {
                        loadPlayer(editTarget.id);
                    } else {
                        loadTeam(editTarget.id);
                    }
                } else {
                    alert('Update failed: ' + data.message);
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save changes');
            }
        }

        // View Management
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');
        }

        // Search Functionality
        async function handleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            
            clearTimeout(searchTimeout);
            
            if (!query) {
                resultsDiv.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${API_BASE}/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    let html = '';
                    
                    data.players.forEach(player => {
                        html += `
                            <div class="search-result-item" onclick="loadPlayer('${player.player_id}')">
                                <span class="result-type">PLAYER</span>
                                <strong>${player.player}</strong>  - Team: ${player.team_id}
                            </div>
                        `;
                    });

                    
                    data.teams.forEach(team => {
                        html += `
                            <div class="search-result-item" onclick="loadTeam('${team.team_id}')">
                                <span class="result-type">TEAM</span>
                                <strong>${team.team_name}</strong>
                            </div>
                        `;
                    });
                    
                    if (html) {
                        resultsDiv.innerHTML = html;
                        resultsDiv.style.display = 'block';
                    } else {
                        resultsDiv.innerHTML = '<div class="search-result-item">No results found</div>';
                        resultsDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        }

        // Load Home Data
        async function loadHomeData() {
            try {
                const response = await fetch(`${API_BASE}/home`);
                const data = await response.json();
                
                // Top Players
                let playersHtml = '<table><thead><tr><th>Rank</th><th>Player</th><th>Team</th><th>Points/Game</th></tr></thead><tbody>';
                data.top_players.forEach((player, index) => {
                    playersHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td class="clickable" onclick="loadPlayer('${player.player_id}')">${player.player}</td>
                            <td class="clickable" onclick="loadTeam('${player.team_id}')">${player.team_id}</td>
                            <td>${player.points_per_game.toFixed(1)}</td>
                        </tr>
                    `;
                });
                playersHtml += '</tbody></table>';
                document.getElementById('topPlayers').innerHTML = playersHtml;
                
                // Top Teams
                let teamsHtml = '<table><thead><tr><th>Rank</th><th>Team</th><th>Points/Game</th></tr></thead><tbody>';
                data.best_teams.forEach((team, index) => {
                    teamsHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td class="clickable" onclick="loadTeam('${team.team_id}')">${team.team_id}</td>
                            <td>${team.points_per_game.toFixed(1)}</td>
                        </tr>
                    `;
                });
                teamsHtml += '</tbody></table>';
                document.getElementById('topTeams').innerHTML = teamsHtml;
                
            } catch (error) {
                console.error('Error loading home data:', error);
                document.getElementById('topPlayers').innerHTML = '<div class="error">Error loading data. Please ensure the Flask server is running.</div>';
                document.getElementById('topTeams').innerHTML = '<div class="error">Error loading data. Please ensure the Flask server is running.</div>';
            }
        }

        // Load Player Page
        async function loadPlayer(playerId) {
            showView('player');
            document.getElementById('playerContent').innerHTML = '<div class="loading">Loading player data...</div>';
            document.getElementById('searchResults').style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/player/${playerId}`);
                const data = await response.json();
                
                const player = data.player_details;
                const team = data.team_link;
                
                // Check if favorited
                let isFavorited = false;
                if (currentUser) {
                    const favCheck = await fetch(
                        `${API_BASE}/favorites/check?target_id=${playerId}&target_type=player`,
                        { credentials: 'include' }
                    );
                    const favData = await favCheck.json();
                    isFavorited = favData.is_favorite;
                }
            

                
                let html = `
                    <div class="player-header">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div class="player-name">${player.player}</div>
                                <div>Player ID: ${player.player_id} | 
                                    Team: <span class="clickable" onclick="loadTeam('${team.team_id}')" style="color: white; text-decoration: underline;">${team.team_id}</span>
                                </div>
                            </div>
                            <div>
                `;
                
                if (currentUser) {
                    html += `<button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-fav-id="${playerId}" onclick="toggleFavorite('${playerId}', 'player')">
                        ${isFavorited ? '‚ù§Ô∏è Favorited' : 'ü§ç Add to Favorites'}
                    </button>`;
                }
                
                if (currentUser && currentUser.is_admin) {
                    html += `<button class="edit-btn" onclick='openEditModal("player", "${playerId}", ${JSON.stringify(player)})'>‚úèÔ∏è Edit</button>`;
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                    
                    <h3>Season Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Points/Game</div>
                            <div class="stat-value">${player.points_per_game.toFixed(1)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Assists/Game</div>
                            <div class="stat-value">${player.assists_per_game.toFixed(1)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Rebounds/Game</div>
                            <div class="stat-value">${player.rebounds_per_game.toFixed(1)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Steals/Game</div>
                            <div class="stat-value">${player.steals_per_game.toFixed(1)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">FG%</div>
                            <div class="stat-value">${player.fg_percentage.toFixed(1)}%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">EuroStat Rating</div>
                            <div class="stat-value">${player.eurostat_rating.toFixed(1)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Games Played</div>
                            <div class="stat-value">${player.games_played || 'N/A'}</div>
                        </div>
                        
                    </div>
                    
                    <div class="subsection">
                        <h3>Match History</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Round</th>
                                    <th>Game</th>
                                    <th>Points</th>
                                    <th>Assists</th>
                                    <th>Rebounds</th>
                                    <th>Steals</th>
                                    <th>FG%</th>
                                    <th>Rating</th>
                                    <th>Minutes</th>
                                    <th>+/-</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.match_history.forEach(match => {
                    html += `
                        <tr class="clickable" onclick="loadMatch('${match.game_id}')">
                            <td>${match.round}</td>
                            <td>${match.game}</td>
                            <td>${match.points}</td>
                            <td>${match.assists}</td>
                            <td>${match.rebounds}</td>
                            <td>${match.steals}</td>
                            <td>${match.fg_percentage.toFixed(1)}%</td>
                            <td>${match.eurostat_rating.toFixed(1)}</td>
                            <td>${match.minutes}</td>
                            <td>${match.plus_minus > 0 ? '+' : ''}${match.plus_minus}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('playerContent').innerHTML = html;
            }catch (error) {
                console.error('Error loading team:', error);
                document.getElementById('teamContent').innerHTML = '<div class="error">Error loading team data.</div>';
            }
        }
            
        
                
        // Load Team Page
        async function loadTeam(teamId) {
            showView('team');
            document.getElementById('teamContent').innerHTML = '<div class="loading">Loading team data...</div>';
            document.getElementById('searchResults').style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/team/${teamId}`);
                const data = await response.json();
                
                const team = data.team_details;
                
                // Check if favorited
                let isFavorited = false;
                if (currentUser) {
                    const favCheck = await fetch(
                        `${API_BASE}/favorites/check?target_id=${teamId}&target_type=team`,
                        { credentials: 'include' }
                    );
                    const favData = await favCheck.json();
                    isFavorited = favData.is_favorite;
                }
                
                let html = `
                    <div class="team-header">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div class="team-name">${team.team_name}</div>
                            <div>
                `;
                
                if (currentUser) {
                    html += `<button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-fav-id="${teamId}" onclick="toggleFavorite('${teamId}', 'team')">
                        ${isFavorited ? '‚ù§Ô∏è Favorited' : 'ü§ç Add to Favorites'}
                    </button>`;
                }
                
                if (currentUser && currentUser.is_admin) {
                    html += `<button class="edit-btn" onclick='openEditModal("team", "${teamId}", ${JSON.stringify(team)})'>‚úèÔ∏è Edit</button>`;
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                    
                    <h3>Team Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Points/Game</div>
                            <div class="stat-value">${team.points_per_game.toFixed(1)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Assists/Game</div>
                            <div class="stat-value">${team.assists_per_game.toFixed(1)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Rebounds/Game</div>
                            <div class="stat-value">${team.total_rebounds_per_game.toFixed(1)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Steals/Game</div>
                            <div class="stat-value">${team.steals_per_game.toFixed(1)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">FG%</div>
                            <div class="stat-value">${team.fg_percentage.toFixed(1)}%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Games Played</div>
                            <div class="stat-value">${team.games_played || 'N/A'}</div>
                        </div>
                        
                    </div>
                    
                    <div class="subsection">
                        <h3>Roster</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>GP</th>
                                    <th>PPG</th>
                                    <th>APG</th>
                                    <th>RPG</th>
                                    <th>SPG</th>
                                    <th>FG%</th>
                                    <th>Rating</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.roster.forEach(player => {
                    html += `
                        <tr class="clickable" onclick="loadPlayer('${player.player_id}')">
                            <td>${player.player}</td>
                            <td>${player.games_played}</td>
                            <td>${player.points_per_game.toFixed(1)}</td>
                            <td>${player.assists_per_game.toFixed(1)}</td>
                            <td>${player.rebounds_per_game.toFixed(1)}</td>
                            <td>${player.steals_per_game.toFixed(1)}</td>
                            <td>${player.fg_percentage.toFixed(1)}%</td>
                            <td>${player.eurostat_rating.toFixed(1)}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="subsection">
                        <h3>Schedule / Match History</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Round</th>
                                    <th>Team A</th>
                                    <th>Team B</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.schedule.forEach(game => {
                    html += `
                        <tr class="clickable" onclick="loadMatch('${game.game_id}')">
                            <td>${game.round}</td>
                            <td>${game.team_id_a}</td>
                            <td>${game.team_id_b}</td>
                            <td>${game.score_a || '?'} - ${game.score_b || '?'}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('teamContent').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading team:', error);
                document.getElementById('teamContent').innerHTML = '<div class="error">Error loading team data.</div>';
            }
        }

        // Load Match Page
        async function loadMatch(gameId) {
            showView('match');
            document.getElementById('matchContent').innerHTML = '<div class="loading">Loading match data...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/match/${gameId}`);
                const data = await response.json();
                
                const game = data.game_info;
                
                let html = `
                    <div class="match-header">
                        <h2>${game.phase}</h2>
                        <div style="text-align: center; color: #666; margin: 10px 0;">
                            ${new Date(game.date).toLocaleDateString()} | ${game.stadium}
                        </div>
                        <div class="match-teams">
                            <div style="text-align: center;">
                                <div class="match-team clickable" onclick="loadTeam('${game.team_id_a}')">${game.team_id_a}</div>
                                
                            </div>
                            <span class="match-score">${game.score_a} - ${game.score_b}</span>
                            <div style="text-align: center;">
                                <div class="match-team clickable" onclick="loadTeam('${game.team_id_b}')">${game.team_id_b}</div>
                                
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px; font-size: 0.9em; color: #666;">
                            Coach: ${game.coach_a} vs ${game.coach_b}
                        </div>
                    </div>
                    
                    <div class="subsection">
                        <h3>${game.team_id_a} - ${game.team_a}</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Player</th>
                                    <th>MIN</th>
                                    <th>PTS</th>
                                    <th>AST</th>
                                    <th>REB</th>
                                    <th>STL</th>
                                    <th>FG%</th>
                                    <th>Rating</th>
                                    <th>+/-</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Sort by is_starter (starters first) and then by minutes played
                const teamA = data.home_team_boxscore.sort((a, b) => {
                    if (b.is_starter !== a.is_starter) return b.is_starter - a.is_starter;
                    const minsA = a.minutes ? parseFloat(a.minutes.split(':')[0]) : 0;
                    const minsB = b.minutes ? parseFloat(b.minutes.split(':')[0]) : 0;
                    return minsB - minsA;
                });
                
                teamA.forEach(stat => {
                    const starterIndicator = stat.is_starter ? '‚òÖ' : '';
                    html += `
                        <tr class="clickable" onclick="loadPlayer('${stat.player_id}')">
                            <td>${stat.dorsal}</td>
                            <td><strong>${stat.player || stat.player_id}</strong> ${starterIndicator}</td>
                            <td>${stat.minutes}</td>
                            <td><strong>${stat.points}</strong></td>
                            <td>${stat.assists || 0}</td>
                            <td>${stat.rebounds || stat.total_rebounds || 0}</td>
                            <td>${stat.steals || 0}</td>
                            <td>${stat.fg_percentage ? stat.fg_percentage.toFixed(1) : '0.0'}%</td>
                            <td>${stat.eurostat_rating ? stat.eurostat_rating.toFixed(1) : '0.0'}</td>
                            <td style="color: ${stat.plus_minus > 0 ? 'green' : stat.plus_minus < 0 ? 'red' : 'black'}">
                                ${stat.plus_minus > 0 ? '+' : ''}${stat.plus_minus}
                            </td>
                        </tr>
                    `;
                });
                
                // Calculate team totals for Team A
                const totalsA = teamA.reduce((acc, stat) => ({
                    points: acc.points + (stat.points || 0),
                    assists: acc.assists + (stat.assists || 0),
                    rebounds: acc.rebounds + (stat.rebounds || stat.total_rebounds || 0),
                    steals: acc.steals + (stat.steals || 0)
                }), {points: 0, assists: 0, rebounds: 0, steals: 0});
                
                html += `
                        <tr style="background: #f0f0f0; font-weight: bold;">
                            <td colspan="3">TEAM TOTALS</td>
                            <td>${totalsA.points}</td>
                            <td>${totalsA.assists}</td>
                            <td>${totalsA.rebounds}</td>
                            <td>${totalsA.steals}</td>
                            <td colspan="3">-</td>
                        </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="subsection">
                        <h3>${game.team_id_b} - ${game.team_b}</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Player</th>
                                    <th>MIN</th>
                                    <th>PTS</th>
                                    <th>AST</th>
                                    <th>REB</th>
                                    <th>STL</th>
                                    <th>FG%</th>
                                    <th>Rating</th>
                                    <th>+/-</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Sort by is_starter (starters first) and then by minutes played
                const teamB = data.away_team_boxscore.sort((a, b) => {
                    if (b.is_starter !== a.is_starter) return b.is_starter - a.is_starter;
                    const minsA = a.minutes ? parseFloat(a.minutes.split(':')[0]) : 0;
                    const minsB = b.minutes ? parseFloat(b.minutes.split(':')[0]) : 0;
                    return minsB - minsA;
                });
                
                teamB.forEach(stat => {
                    const starterIndicator = stat.is_starter ? '‚òÖ' : '';
                    html += `
                        <tr class="clickable" onclick="loadPlayer('${stat.player_id}')">
                            <td>${stat.dorsal}</td>
                            <td><strong>${stat.player || stat.player_id}</strong> ${starterIndicator}</td>
                            <td>${stat.minutes}</td>
                            <td><strong>${stat.points}</strong></td>
                            <td>${stat.assists || 0}</td>
                            <td>${stat.rebounds || stat.total_rebounds || 0}</td>
                            <td>${stat.steals || 0}</td>
                            <td>${stat.fg_percentage ? stat.fg_percentage.toFixed(1) : '0.0'}%</td>
                            <td>${stat.eurostat_rating ? stat.eurostat_rating.toFixed(1) : '0.0'}</td>
                            <td style="color: ${stat.plus_minus > 0 ? 'green' : stat.plus_minus < 0 ? 'red' : 'black'}">
                                ${stat.plus_minus > 0 ? '+' : ''}${stat.plus_minus}
                            </td>
                        </tr>
                    `;
                });
                
                // Calculate team totals for Team B
                const totalsB = teamB.reduce((acc, stat) => ({
                    points: acc.points + (stat.points || 0),
                    assists: acc.assists + (stat.assists || 0),
                    rebounds: acc.rebounds + (stat.rebounds || stat.total_rebounds || 0),
                    steals: acc.steals + (stat.steals || 0)
                }), {points: 0, assists: 0, rebounds: 0, steals: 0});
                
                html += `
                        <tr style="background: #f0f0f0; font-weight: bold;">
                            <td colspan="3">TEAM TOTALS</td>
                            <td>${totalsB.points}</td>
                            <td>${totalsB.assists}</td>
                            <td>${totalsB.rebounds}</td>
                            <td>${totalsB.steals}</td>
                            <td colspan="3">-</td>
                        </tr>
                            </tbody>
                        </table>
                    </div>
                    <p>‚òÖ Player in starting 5</p>
                `;
                
                document.getElementById('matchContent').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading match:', error);
                document.getElementById('matchContent').innerHTML = '<div class="error">Error loading match data.</div>';
            }
        }
    </script>
</body>
</html>